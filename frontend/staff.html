<!DOCTYPE html>
<html>
<head>
  <title>Staff Portal - XVision IPTV</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Login Section -->
    <div id="staffLoginBox" class="form-container">
      <div class="form-header">
        <h2><i class="fas fa-user-shield"></i> Staff Login</h2>
        <p>Access the administration dashboard</p>
      </div>
      
      <div class="form-group">
        <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
        <input id="email" type="email" placeholder="staff@xvision-tv.xyz">
      </div>
      
      <div class="form-group">
        <label for="password"><i class="fas fa-lock"></i> Password</label>
        <input id="password" type="password" placeholder="Enter your password">
      </div>
      
      <button onclick="staffLogin()" class="btn btn-primary btn-block">
        <i class="fas fa-sign-in-alt"></i> Login to Dashboard
      </button>
      
      <p class="text-center" style="margin-top: 20px;">
        <a href="index.html"><i class="fas fa-home"></i> Back to Home</a>
      </p>
    </div>

    <!-- Admin Dashboard -->
    <div id="staffPanel" style="display:none">
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <h2><i class="fas fa-tachometer-alt"></i> Staff Dashboard</h2>
        <div class="user-info">
          <span id="staffEmailDisplay">Logged in as: Loading...</span>
          <button onclick="logout()" class="btn btn-small">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(76, 175, 80, 0.2);">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <h3 id="customerCount">0</h3>
            <p>Customers</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(33, 150, 243, 0.2);">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3 id="pendingCount">0</h3>
            <p>Pending Requests</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(255, 152, 0, 0.2);">
            <i class="fas fa-film"></i>
          </div>
          <div class="stat-info">
            <h3 id="filmRequestCount">0</h3>
            <p>Film Requests</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(244, 67, 54, 0.2);">
            <i class="fas fa-headset"></i>
          </div>
          <div class="stat-info">
            <h3 id="supportCount">0</h3>
            <p>Support Tickets</p>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="section-header">
        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
      </div>
      <div class="quick-actions">
        <button onclick="showCreateCustomer()" class="action-btn">
          <i class="fas fa-user-plus"></i> Create Customer
        </button>
        <button onclick="refreshData()" class="action-btn">
          <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
        <button onclick="showAllCustomers()" class="action-btn">
          <i class="fas fa-list"></i> View All Customers
        </button>
      </div>

      <!-- Create Customer Form -->
      <div id="createCustomerForm" style="display:none; margin: 20px 0;">
        <div class="form-card">
          <h4><i class="fas fa-user-plus"></i> Create New Customer</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input id="cemail" type="email" placeholder="customer@example.com">
            </div>
            <div class="form-group">
              <label>Password</label>
              <input id="cpass" type="password" placeholder="Set a password">
            </div>
            <div class="form-group">
              <label>Expiry Date</label>
              <input id="cexp" type="date">
            </div>
          </div>
          <div class="form-actions">
            <button onclick="createCustomer()" class="btn btn-primary">
              <i class="fas fa-check"></i> Create Customer
            </button>
            <button onclick="hideCreateCustomer()" class="btn btn-outline">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Tabs for Different Data Views -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('pending')">
          <i class="fas fa-clock"></i> Pending Requests
        </button>
        <button class="tab-btn" onclick="showTab('customers')">
          <i class="fas fa-users"></i> Customers
        </button>
        <button class="tab-btn" onclick="showTab('films')">
          <i class="fas fa-film"></i> Film Requests
        </button>
        <button class="tab-btn" onclick="showTab('support')">
          <i class="fas fa-headset"></i> Support Tickets
        </button>
      </div>

      <!-- Pending Requests Table -->
      <div id="pendingTab" class="tab-content active">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Plan</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pendingTableBody">
              <!-- Data loaded by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Customers Table -->
      <div id="customersTab" class="tab-content">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Expiry Date</th>
                <th>Created</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTableBody">
              <!-- Data loaded by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Film Requests Table -->
      <div id="filmsTab" class="tab-content">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Film Title</th>
                <th>Requested By</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="filmsTableBody">
              <!-- Data loaded by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Support Tickets Table -->
      <div id="supportTab" class="tab-content">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Message</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="supportTableBody">
              <!-- Data loaded by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // Admin Dashboard Functions
    let currentStaffEmail = '';
    
    // Enhanced staff login with dashboard loading
    async function staffLogin() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      if (!email || !password) {
        alert("Please enter both email and password");
        return;
      }

      try {
        const res = await fetch("https://xvision-backend-ao7z.onrender.com/staff/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || "Login failed");
          return;
        }

        // Store staff info
        currentStaffEmail = data.email;
        localStorage.setItem("staffEmail", data.email);
        localStorage.setItem("staffRole", data.role);
        
        // Show dashboard
        document.getElementById("staffLoginBox").style.display = "none";
        document.getElementById("staffPanel").style.display = "block";
        
        // Display staff email
        document.getElementById("staffEmailDisplay").textContent = `Logged in as: ${data.email}`;
        
        // Load all data
        await loadDashboardData();
        
      } catch (err) {
        alert("Server error. Please try again.");
        console.error(err);
      }
    }
    
    // Load all dashboard data
    async function loadDashboardData() {
      await loadPendingRequests();
      await loadCustomers();
      await loadFilmRequests();
      await loadSupportTickets();
      updateStats();
    }
    
    // Load pending requests
    async function loadPendingRequests() {
      try {
        const res = await fetch("https://xvision-backend-ao7z.onrender.com/staff/pending");
        const data = await res.json();
        
        const tbody = document.getElementById("pendingTableBody");
        tbody.innerHTML = '';
        
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No pending requests</td></tr>';
          return;
        }
        
        data.forEach(item => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.email || 'N/A'}</td>
            <td>${item.name || 'N/A'}</td>
            <td>${item.plan || 'N/A'}</td>
            <td>${item.date ? new Date(item.date).toLocaleDateString() : 'N/A'}</td>
            <td>
              <button onclick="approveRequest('${item.email}')" class="btn-small btn-success">
                <i class="fas fa-check"></i> Approve
              </button>
              <button onclick="deletePending('${item.email}')" class="btn-small btn-danger">
                <i class="fas fa-trash"></i> Delete
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
      } catch (err) {
        console.error("Error loading pending requests:", err);
      }
    }
    
    // Load customers
    async function loadCustomers() {
      // Note: You'll need to add a /staff/customers endpoint to your backend
      // For now, we'll create a simple mock
      updateCustomerCount(25); // Mock count
      
      const tbody = document.getElementById("customersTableBody");
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center;">
            Customer list functionality requires backend endpoint
          </td>
        </tr>
      `;
    }
    
    // Load film requests
    async function loadFilmRequests() {
      // Note: You'll need to add a /staff/films endpoint to your backend
      updateFilmRequestCount(12); // Mock count
      
      const tbody = document.getElementById("filmsTableBody");
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center;">
            Film requests functionality requires backend endpoint
          </td>
        </tr>
      `;
    }
    
    // Load support tickets
    async function loadSupportTickets() {
      // Note: You'll need to add a /staff/support endpoint to your backend
      updateSupportCount(8); // Mock count
      
      const tbody = document.getElementById("supportTableBody");
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center;">
            Support tickets functionality requires backend endpoint
          </td>
        </tr>
      `;
    }
    
    // Update stats counters
    function updateStats() {
      // These would come from your actual data
      document.getElementById("customerCount").textContent = "25";
      document.getElementById("pendingCount").textContent = document.querySelectorAll("#pendingTableBody tr").length - 1;
      document.getElementById("filmRequestCount").textContent = "12";
      document.getElementById("supportCount").textContent = "8";
    }
    
    function updateCustomerCount(count) {
      document.getElementById("customerCount").textContent = count;
    }
    
    function updateFilmRequestCount(count) {
      document.getElementById("filmRequestCount").textContent = count;
    }
    
    function updateSupportCount(count) {
      document.getElementById("supportCount").textContent = count;
    }
    
    // Tab navigation
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
    }
    
    // Show/Hide create customer form
    function showCreateCustomer() {
      document.getElementById("createCustomerForm").style.display = "block";
    }
    
    function hideCreateCustomer() {
      document.getElementById("createCustomerForm").style.display = "none";
    }
    
    // Show all customers
    function showAllCustomers() {
      showTab('customers');
    }
    
    // Refresh all data
    function refreshData() {
      loadDashboardData();
      alert("Data refreshed!");
    }
    
    // Approve request (mock function)
    function approveRequest(email) {
      if (confirm(`Approve account request for ${email}?`)) {
        alert(`Request for ${email} approved!`);
        loadPendingRequests();
      }
    }
    
    // Delete pending request (mock function)
    function deletePending(email) {
      if (confirm(`Delete request from ${email}?`)) {
        alert(`Request from ${email} deleted!`);
        loadPendingRequests();
      }
    }
    
    // Logout function
    function logout() {
      localStorage.removeItem("staffEmail");
      localStorage.removeItem("staffRole");
      document.getElementById("staffPanel").style.display = "none";
      document.getElementById("staffLoginBox").style.display = "block";
      document.getElementById("email").value = "";
      document.getElementById("password").value = "";
    }
    
    // Auto-login if staff data exists
    window.onload = function() {
      const savedEmail = localStorage.getItem("staffEmail");
      if (savedEmail) {
        document.getElementById("email").value = savedEmail;
      }
    };
  </script>
</body>
</html>