<!DOCTYPE html>
<html>
<head>
  <title>Staff Portal - XVision IPTV</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Login Section -->
    <div id="staffLoginBox" class="form-container">
      <div class="form-header">
        <h2><i class="fas fa-user-shield"></i> Staff Login</h2>
        <p>Access the administration dashboard</p>
      </div>
      
      <div class="form-group">
        <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
        <input id="email" type="email" placeholder="staff@xvision-tv.xyz">
      </div>
      
      <div class="form-group">
        <label for="password"><i class="fas fa-lock"></i> Password</label>
        <input id="password" type="password" placeholder="Enter your password">
      </div>
      
      <button onclick="staffLogin()" class="btn btn-primary btn-block">
        <i class="fas fa-sign-in-alt"></i> Login to Dashboard
      </button>
      
      <p class="text-center" style="margin-top: 20px;">
        <a href="index.html"><i class="fas fa-home"></i> Back to Home</a>
      </p>
    </div>

    <!-- Admin Dashboard -->
    <div id="staffPanel" style="display:none">
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <h2><i class="fas fa-tachometer-alt"></i> Staff Dashboard</h2>
        <div class="user-info">
          <span id="staffEmailDisplay">Logged in as: Loading...</span>
          <button onclick="logout()" class="btn btn-small">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(76, 175, 80, 0.2);">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <h3 id="customerCount">0</h3>
            <p>Customers</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(33, 150, 243, 0.2);">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3 id="pendingCount">0</h3>
            <p>Pending Requests</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(255, 152, 0, 0.2);">
            <i class="fas fa-film"></i>
          </div>
          <div class="stat-info">
            <h3 id="filmRequestCount">0</h3>
            <p>Film Requests</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(244, 67, 54, 0.2);">
            <i class="fas fa-headset"></i>
          </div>
          <div class="stat-info">
            <h3 id="supportCount">0</h3>
            <p>Support Tickets</p>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="section-header">
        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
      </div>
      <div class="quick-actions">
        <button onclick="showCreateCustomer()" class="action-btn">
          <i class="fas fa-user-plus"></i> Create Customer
        </button>
        <button onclick="refreshData()" class="action-btn">
          <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
        <button onclick="showAllCustomers()" class="action-btn">
          <i class="fas fa-list"></i> View All Customers
        </button>
      </div>

      <!-- Create Customer Form -->
      <div id="createCustomerForm" style="display:none; margin: 20px 0;">
        <div class="form-card">
          <h4><i class="fas fa-user-plus"></i> Create New Customer</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input id="cemail" type="email" placeholder="customer@example.com">
            </div>
            <div class="form-group">
              <label>Password</label>
              <input id="cpass" type="password" placeholder="Set a password">
            </div>
            <div class="form-group">
              <label>Expiry Date</label>
              <input id="cexp" type="date">
            </div>
          </div>
          <div class="form-actions">
            <button onclick="createCustomer()" class="btn btn-primary">
              <i class="fas fa-check"></i> Create Customer
            </button>
            <button onclick="hideCreateCustomer()" class="btn btn-outline">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Tabs for Different Data Views -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('pending')">
          <i class="fas fa-clock"></i> Pending Requests
        </button>
        <button class="tab-btn" onclick="showTab('customers')">
          <i class="fas fa-users"></i> Customers
        </button>
        <button class="tab-btn" onclick="showTab('films')">
          <i class="fas fa-film"></i> Film Requests
        </button>
        <button class="tab-btn" onclick="showTab('support')">
          <i class="fas fa-headset"></i> Support Tickets
        </button>
      </div>

      <!-- Pending Requests Table -->
      <div id="pendingTab" class="tab-content active">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Plan</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pendingTableBody">
              <!-- Data loaded by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Customers Table -->
      <div id="customersTab" class="tab-content">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Expiry Date</th>
                <th>Created</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTableBody">
              <!-- Data loaded by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Film Requests Table -->
      <div id="filmsTab" class="tab-content">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Film Title</th>
                <th>Requested By</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="filmsTableBody">
              <!-- Data loaded by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Support Tickets Table -->
      <div id="supportTab" class="tab-content">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Message</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="supportTableBody">
              <!-- Data loaded by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

 
  <script src="script.js"></script>
<script>
    // Admin Dashboard Functions
    let currentStaffEmail = '';
    const API_BASE = "https://xvision-backend-ao7z.onrender.com";
    
    // Enhanced staff login with dashboard loading
    async function staffLogin() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        if (!email || !password) {
            alert("Please enter both email and password");
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/staff/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            });

            const data = await res.json();

            if (!res.ok) {
                alert(data.error || "Login failed");
                return;
            }

            // Store staff info
            currentStaffEmail = data.email;
            localStorage.setItem("staffEmail", data.email);
            localStorage.setItem("staffRole", data.role);
            
            // Show dashboard
            document.getElementById("staffLoginBox").style.display = "none";
            document.getElementById("staffPanel").style.display = "block";
            
            // Display staff email
            document.getElementById("staffEmailDisplay").textContent = `Logged in as: ${data.email}`;
            
            // Load all data
            await loadDashboardData();
            
        } catch (err) {
            alert("Server error. Please try again.");
            console.error(err);
        }
    }
    
    // Load all dashboard data
    async function loadDashboardData() {
        await loadStats();
        await loadPendingRequests();
        await loadCustomers();
        await loadFilmRequests();
        await loadSupportTickets();
    }
    
    // Load statistics
    async function loadStats() {
        try {
            const res = await fetch(`${API_BASE}/staff/stats`);
            if (!res.ok) return;
            
            const data = await res.json();
            
            // Update count displays
            document.getElementById("customerCount").textContent = data.customers || 0;
            document.getElementById("pendingCount").textContent = data.pending || 0;
            document.getElementById("filmRequestCount").textContent = data.films || 0;
            document.getElementById("supportCount").textContent = data.support || 0;
            
        } catch (err) {
            console.error("Error loading stats:", err);
        }
    }
    
    // Load pending requests
    async function loadPendingRequests() {
        try {
            const res = await fetch(`${API_BASE}/staff/pending`);
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            
            const data = await res.json();
            const tbody = document.getElementById("pendingTableBody");
            tbody.innerHTML = '';
            
            if (!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No pending requests</td></tr>';
                return;
            }
            
            data.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${escapeHtml(item.email || 'N/A')}</td>
                    <td>${escapeHtml(item.name || 'N/A')}</td>
                    <td>${escapeHtml(item.plan || 'N/A')}</td>
                    <td>${item.date ? formatDate(item.date) : 'N/A'}</td>
                    <td class="action-buttons">
                        <button onclick="approveRequest('${escapeHtml(item.email)}')" class="btn-small btn-success">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button onclick="deletePendingRequest('${escapeHtml(item.email)}')" class="btn-small btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
        } catch (err) {
            console.error("Error loading pending requests:", err);
            const tbody = document.getElementById("pendingTableBody");
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: #F44336;">
                        Error: ${err.message}
                    </td>
                </tr>
            `;
        }
    }
    
    // Load customers - FIXED
    async function loadCustomers() {
        try {
            const res = await fetch(`${API_BASE}/staff/customers`);
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            
            const data = await res.json();
            const tbody = document.getElementById("customersTableBody");
            tbody.innerHTML = '';
            
            if (!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No customers found</td></tr>';
                return;
            }
            
            data.forEach(customer => {
                const expiresDate = customer.expires ? new Date(customer.expires) : null;
                const isExpired = expiresDate ? expiresDate < new Date() : false;
                
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${escapeHtml(customer.email || 'N/A')}</td>
                    <td>${customer.expires || 'N/A'}</td>
                    <td>${customer.created ? formatDate(customer.created) : 'N/A'}</td>
                    <td>
                        <span class="status-badge ${isExpired ? 'expired' : 'active'}">
                            ${isExpired ? 'Expired' : 'Active'}
                        </span>
                    </td>
                    <td class="action-buttons">
                        <button onclick="deleteCustomer('${escapeHtml(customer.email)}')" class="btn-small btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
        } catch (err) {
            console.error("Error loading customers:", err);
            const tbody = document.getElementById("customersTableBody");
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: #F44336;">
                        Error: ${err.message}
                    </td>
                </tr>
            `;
        }
    }
    
    // Load film requests - FIXED
    async function loadFilmRequests() {
        try {
            const res = await fetch(`${API_BASE}/staff/films/all`);
            if (!res.ok) {
                // Fallback to old endpoint
                const res2 = await fetch(`${API_BASE}/staff/films`);
                if (!res2.ok) throw new Error(`HTTP ${res2.status}`);
                
                const data = await res2.json();
                renderFilmsTable(data);
                return;
            }
            
            const data = await res.json();
            renderFilmsTable(data);
            
        } catch (err) {
            console.error("Error loading film requests:", err);
            const tbody = document.getElementById("filmsTableBody");
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: #F44336;">
                        Error: ${err.message}
                    </td>
                </tr>
            `;
        }
    }
    
    function renderFilmsTable(data) {
        const tbody = document.getElementById("filmsTableBody");
        tbody.innerHTML = '';
        
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No film requests</td></tr>';
            return;
        }
        
        data.forEach(film => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${escapeHtml(film.title || 'N/A')}</td>
                <td>${escapeHtml(film.email || film.requestedBy || 'Anonymous')}</td>
                <td>${film.date ? formatDate(film.date) : 'N/A'}</td>
                <td>
                    <span class="status-badge pending">
                        Pending
                    </span>
                </td>
                <td class="action-buttons">
                    <button onclick="deleteFilmRequest('${escapeHtml(film.title)}')" class="btn-small btn-danger">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // Load support tickets - FIXED
    async function loadSupportTickets() {
        try {
            const res = await fetch(`${API_BASE}/staff/support/all`);
            if (!res.ok) {
                // Fallback to old endpoint
                const res2 = await fetch(`${API_BASE}/staff/support-tickets`);
                if (!res2.ok) throw new Error(`HTTP ${res2.status}`);
                
                const data = await res2.json();
                renderSupportTable(data);
                return;
            }
            
            const data = await res.json();
            renderSupportTable(data);
            
        } catch (err) {
            console.error("Error loading support tickets:", err);
            const tbody = document.getElementById("supportTableBody");
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: #F44336;">
                        Error: ${err.message}
                    </td>
                </tr>
            `;
        }
    }
    
    function renderSupportTable(data) {
        const tbody = document.getElementById("supportTableBody");
        tbody.innerHTML = '';
        
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No support tickets</td></tr>';
            return;
        }
        
        data.forEach(ticket => {
            const messagePreview = ticket.message ? 
                (ticket.message.length > 50 ? ticket.message.substring(0, 50) + '...' : ticket.message) : 
                'No message';
            
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${escapeHtml(ticket.email || 'Anonymous')}</td>
                <td title="${escapeHtml(ticket.message || '')}">${escapeHtml(messagePreview)}</td>
                <td>${ticket.date ? formatDate(ticket.date) : 'N/A'}</td>
                <td>
                    <span class="status-badge ${ticket.status === 'resolved' ? 'resolved' : 'open'}">
                        ${ticket.status || 'Open'}
                    </span>
                </td>
                <td class="action-buttons">
                    <button onclick="deleteSupportTicket('${escapeHtml(ticket.email)}')" class="btn-small btn-danger">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // Tab navigation - FIXED
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // Add active class to clicked button
        event.target.classList.add('active');
    }
    
    // Show/Hide create customer form
    function showCreateCustomer() {
        document.getElementById("createCustomerForm").style.display = "block";
    }
    
    function hideCreateCustomer() {
        document.getElementById("createCustomerForm").style.display = "none";
    }
    
    // Show all customers - FIXED
    function showAllCustomers() {
        showTab('customers');
        loadCustomers(); // Refresh data when clicking the button
    }
    
    // Refresh all data
    function refreshData() {
        loadDashboardData();
        showNotification("Data refreshed successfully!", "success");
    }
    
    // Approve request (mock function - you need to implement)
    async function approveRequest(email) {
        if (confirm(`Approve account request for ${email}?`)) {
            try {
                // First create customer account
                const password = generateRandomPassword();
                const expires = new Date();
                expires.setFullYear(expires.getFullYear() + 1); // 1 year expiry
                
                const res = await fetch(`${API_BASE}/staff/create`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        email: email, 
                        password: password,
                        expires: expires.toISOString().split('T')[0]
                    })
                });
                
                if (res.ok) {
                    // Then delete from pending
                    await deletePendingRequest(email);
                    showNotification(`Account created for ${email}! Password: ${password}`, "success");
                    loadDashboardData();
                } else {
                    const data = await res.json();
                    showNotification(`Error: ${data.error}`, "error");
                }
            } catch (err) {
                showNotification("Error approving request", "error");
            }
        }
    }
    
    // Delete functions
    async function deletePendingRequest(email) {
        if (confirm(`Delete pending request from ${email}?`)) {
            try {
                const res = await fetch(`${API_BASE}/staff/delete/pending/${encodeURIComponent(email)}`, {
                    method: "DELETE"
                });
                
                if (res.ok) {
                    showNotification("Pending request deleted!", "success");
                    loadPendingRequests();
                    loadStats();
                } else {
                    showNotification("Failed to delete", "error");
                }
            } catch (err) {
                showNotification("Error deleting request", "error");
            }
        }
    }
    
    async function deleteCustomer(email) {
        if (confirm(`Delete customer account ${email}? This cannot be undone.`)) {
            try {
                const res = await fetch(`${API_BASE}/staff/delete/customer/${encodeURIComponent(email)}`, {
                    method: "DELETE"
                });
                
                if (res.ok) {
                    showNotification("Customer deleted!", "success");
                    loadCustomers();
                    loadStats();
                } else {
                    showNotification("Failed to delete customer", "error");
                }
            } catch (err) {
                showNotification("Error deleting customer", "error");
            }
        }
    }
    
    async function deleteFilmRequest(title) {
        if (confirm(`Delete film request: "${title}"?`)) {
            try {
                const res = await fetch(`${API_BASE}/staff/delete/film/${encodeURIComponent(title)}`, {
                    method: "DELETE"
                });
                
                if (res.ok) {
                    showNotification("Film request deleted!", "success");
                    loadFilmRequests();
                    loadStats();
                } else {
                    showNotification("Failed to delete", "error");
                }
            } catch (err) {
                showNotification("Error deleting film request", "error");
            }
        }
    }
    
    async function deleteSupportTicket(email) {
        if (confirm(`Delete support ticket from ${email}?`)) {
            try {
                const res = await fetch(`${API_BASE}/staff/delete/support/${encodeURIComponent(email)}`, {
                    method: "DELETE"
                });
                
                if (res.ok) {
                    showNotification("Support ticket deleted!", "success");
                    loadSupportTickets();
                    loadStats();
                } else {
                    showNotification("Failed to delete", "error");
                }
            } catch (err) {
                showNotification("Error deleting support ticket", "error");
            }
        }
    }
    
    // Logout function
    function logout() {
        localStorage.removeItem("staffEmail");
        localStorage.removeItem("staffRole");
        document.getElementById("staffPanel").style.display = "none";
        document.getElementById("staffLoginBox").style.display = "block";
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";
    }
    
    // Utility functions
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } catch (e) {
            return dateString;
        }
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function generateRandomPassword() {
        return Math.random().toString(36).slice(-8);
    }
    
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">&times;</button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Auto-login if staff data exists
    window.onload = function() {
        const savedEmail = localStorage.getItem("staffEmail");
        if (savedEmail) {
            document.getElementById("email").value = savedEmail;
        }
    };
</script>

<style>
    /* Add these styles to your existing styles.css */
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .status-badge.active {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        border: 1px solid #4CAF50;
    }
    
    .status-badge.expired {
        background: rgba(244, 67, 54, 0.2);
        color: #F44336;
        border: 1px solid #F44336;
    }
    
    .status-badge.pending {
        background: rgba(255, 152, 0, 0.2);
        color: #FF9800;
        border: 1px solid #FF9800;
    }
    
    .status-badge.open {
        background: rgba(33, 150, 243, 0.2);
        color: #2196F3;
        border: 1px solid #2196F3;
    }
    
    .status-badge.resolved {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        border: 1px solid #4CAF50;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: nowrap;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    }
    
    .notification.success {
        background: rgba(76, 175, 80, 0.9);
        color: white;
        border: 1px solid #4CAF50;
    }
    
    .notification.error {
        background: rgba(244, 67, 54, 0.9);
        color: white;
        border: 1px solid #F44336;
    }
    
    .notification button {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        margin-left: auto;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
</body>
</html>